<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>SmartLoan - Login & Simulazione</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

    <div class="container py-5">

        <h1 class="text-center mb-4">SmartLoan</h1>

        <!-- Login Section -->
        <div id="loginSection" class="card mx-auto p-4 shadow" style="max-width: 400px;">
            <h4 class="mb-3">Accedi</h4>
            <form id="loginForm">
                <input type="text" id="loginUsername" class="form-control mb-2" placeholder="Username" required />
                <input type="password" id="loginPassword" class="form-control mb-3" placeholder="Password" required />
                <button type="submit" class="btn btn-success w-100">Login</button>
            </form>
            <div id="loginMsg" class="mt-2 small text-danger"></div>
            <div class="mt-3 text-center">
                <a href="#" onclick="showSection('registerSection')">Non hai un account? Registrati</a>
            </div>
        </div>

        <!-- Register Section (initially hidden) -->
        <div id="registerSection" class="card mx-auto p-4 shadow d-none" style="max-width: 400px;">
            <h4 class="mb-3">Registrazione</h4>
            <form id="registerForm">
                <input type="text" id="registerUsername" class="form-control mb-2" placeholder="Username" required />
                <input type="email" id="registerEmail" class="form-control mb-2" placeholder="Email" required />
                <input type="password" id="registerPassword" class="form-control mb-3" placeholder="Password" required />
                <button type="submit" class="btn btn-primary w-100">Registrati</button>
            </form>
            <div id="registerMsg" class="mt-2 small text-success"></div>
        </div>

        <!-- Loan Section (initially hidden) -->
        <div id="loanSection" class="card mx-auto p-4 shadow d-none mt-5" style="max-width: 500px;">
            <h4 class="mb-3">Simulazione Prestito</h4>
            <form id="loanForm">
                <input type="number" step="0.01" id="importo" class="form-control mb-2" placeholder="Importo (€)" required />
                <input type="number" step="0.01" id="tasso" class="form-control mb-2" placeholder="Tasso Annuale (%)" required />
                <input type="number" id="mesi" class="form-control mb-3" placeholder="Durata (mesi)" required />
                <button type="submit" class="btn btn-warning w-100">Calcola Rata</button>
            </form>
            <div id="loanResult" class="mt-3 text-info fw-bold"></div>
            <div class="text-end mt-2">
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiUrl = "https://localhost:7194"; // Cambia se necessario
        let token = "";

        function showSection(sectionId) {
            const sections = ["loginSection", "registerSection", "loanSection"];
            sections.forEach(id => {
                document.getElementById(id).classList.add("d-none");
            });
            document.getElementById(sectionId).classList.remove("d-none");
        }


        function logout() {
            token = "";
            document.getElementById("loanSection").classList.add("d-none");
            document.getElementById("loginSection").classList.remove("d-none");
        }

        // Registrazione
        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("registerUsername").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            const res = await fetch(`${apiUrl}/api/Auth/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, email, password })
            });

            const msg = document.getElementById("registerMsg");
            if (res.ok) {
                msg.textContent = "Registrazione completata! Ora accedi.";
                setTimeout(() => {
                    msg.textContent = "";
                    showSection("loginSection");

                }, 1000);
            } else {
                msg.textContent = "Errore: sei già registrato!";
            }
        });

        // Login
        document.getElementById("loginForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("loginUsername").value;
            const password = document.getElementById("loginPassword").value;

            const res = await fetch(`${apiUrl}/api/Auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            const msg = document.getElementById("loginMsg");
            const data = await res.json();

            if (res.ok) {
                token = data.token;
                msg.textContent = "";
                showSection("loanSection");
            } else {
                msg.textContent = "Credenziali non valide.";
            }
        });

        // Calcolo rata
        document.getElementById("loanForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const importo = parseFloat(document.getElementById("importo").value);
            const tasso = parseFloat(document.getElementById("tasso").value);
            const mesi = parseInt(document.getElementById("mesi").value);

            const res = await fetch(`${apiUrl}/api/LoanSimulation/simulate`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ importo, tassoAnnuale: tasso, durataMesi: mesi })
            });

            const data = await res.json();
            const result = document.getElementById("loanResult");
            result.textContent = res.ok
                ? `Rata Mensile: € ${data.rataMensile.toFixed(2)}`
                : "Errore nella simulazione.";
        });

        window.onload = () => {
            showSection("loginSection");
        };
    </script>

</body>
</html>
